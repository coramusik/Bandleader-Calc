<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bandleader Compensation Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .calculator { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid-container { grid-template-columns: 1fr; } }
        .section { margin-bottom: 20px; }
        .section-title { font-weight: bold; padding: 8px; margin-bottom: 15px; font-size: 18px; border-radius: 4px; }
        .yellow-bg { background-color: #fef08a; }
        .blue-bg { background-color: #bfdbfe; }
        .green-bg { background-color: #bbf7d0; }
        .purple-bg { background-color: #e9d5ff; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 500; margin-bottom: 5px; font-size: 14px; }
        input, select { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #d1d5db; 
            border-radius: 4px; 
            font-size: 16px;
            height: 38px;
        }
        .currency-input { 
            position: relative; 
            display: flex;
            align-items: center;
        }
        .currency-symbol { 
            position: absolute; 
            left: 10px; 
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            color: #6b7280;
            line-height: 1;
            pointer-events: none;
        }
        .currency-input input { 
            padding-left: 25px; 
        }
        .result-box { background-color: #f9fafb; border: 1px solid #d1d5db; padding: 8px; border-radius: 4px; margin-top: 5px; }
        .helper-text { font-size: 12px; color: #6b7280; margin-top: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
        th { background-color: #f9fafb; font-size: 12px; text-transform: uppercase; }
        .reference-box { background-color: #f9fafb; border: 1px solid #d1d5db; padding: 15px; border-radius: 4px; margin-top: 20px; }
        .ethical-good { background-color: #d1fae5; color: #047857; }
        .ethical-bad { background-color: #fee2e2; color: #b91c1c; }
        .ethical-warning { background-color: #fef3c7; color: #92400e; }
        .gig-info { padding: 15px; background-color: #f0f9ff; border-radius: 8px; margin-bottom: 20px; border: 1px solid #bae6fd; }
        .save-section { background-color: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #d1d5db; }
        .btn { padding: 8px 16px; border-radius: 4px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-blue { background-color: #3b82f6; color: white; border: none; }
        .btn-blue:hover { background-color: #2563eb; }
        .btn-green { background-color: #10b981; color: white; border: none; }
        .btn-green:hover { background-color: #059669; }
        .btn-red { background-color: #ef4444; color: white; border: none; }
        .btn-red:hover { background-color: #dc2626; }
        .saved-calculations { max-height: 200px; overflow-y: auto; margin-top: 10px; }
        .saved-item { padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 8px; background-color: white; display: flex; justify-content: space-between; align-items: center; }
        .saved-item-details { flex-grow: 1; }
        .saved-item-buttons { display: flex; gap: 4px; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal { background-color: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="calculator">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">Bandleader Compensation Calculator</h1>
            <div>
                <label for="currency" class="mr-2">Base Currency:</label>
                <select id="currency" class="py-1 px-2 border rounded">
                    <option value="EUR">EUR (€)</option>
                    <option value="GBP">GBP (£)</option>
                    <option value="USD">USD ($)</option>
                </select>
            </div>
        </div>

        <!-- Save/Load Section -->
        <div class="save-section">
            <h2 class="font-semibold mb-3">Save/Load Calculations</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <div class="form-group">
                        <label for="saveName">Save Name</label>
                        <input type="text" id="saveName" placeholder="e.g., Jazz Festival 2025">
                    </div>
                    <button id="saveButton" class="btn btn-blue mt-2" onclick="saveCalculation()">Save Current Calculation</button>
                    
                    <!-- New Export/Import buttons -->
                    <div class="mt-4 flex gap-2">
                        <button id="exportButton" class="btn btn-blue" onclick="exportCalculations()">Export All</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                        <button id="importButton" class="btn btn-blue" onclick="document.getElementById('importFile').click()">Import</button>
                    </div>
                </div>
                <div>
                    <h3 class="font-medium mb-2">Saved Calculations</h3>
                    <div id="savedCalculations" class="saved-calculations">
                        <!-- Saved items will be added here -->
                        <div class="text-gray-500 text-sm italic">No saved calculations yet</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- New section for Venue and Location -->
        <div class="gig-info">
            <h2 class="font-semibold mb-3">Gig Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="venueName">Venue Name</label>
                    <input type="text" id="venueName" placeholder="Enter venue name">
                </div>
                <div class="form-group">
                    <label for="venueLocation">Venue Location</label>
                    <input type="text" id="venueLocation" placeholder="Enter city/location">
                </div>
            </div>
            <div class="form-group mt-2">
                <label for="gigDate">Date</label>
                <input type="date" id="gigDate">
            </div>
        </div>

        <div class="grid-container">
            <!-- Input Section -->
            <div class="section">
                <h2 class="section-title yellow-bg">Input Values</h2>
                
                <div class="form-group">
                    <label for="grossFee">Gross Fee</label>
                    <div class="currency-input">
                        <span class="currency-symbol" id="currencySymbol">€</span>
                        <input type="number" id="grossFee" value="6000">
                    </div>
                    <div class="helper-text">Enter the total fee for the gig</div>
                </div>

                <div class="form-group">
                    <label for="bookingFeePercent">Booking Fee %</label>
                    <input type="number" id="bookingFeePercent" value="">
                    <div class="helper-text">Standard is 10% unless otherwise specified</div>
                </div>

                <div class="form-group">
                    <label for="transportCosts">Transportation Costs</label>
                    <div class="currency-input">
                        <span class="currency-symbol" id="currencySymbol2">€</span>
                        <input type="number" id="transportCosts" value="1500">
                    </div>
                    <div class="helper-text">Enter total transportation and other direct costs</div>
                </div>

                <div class="form-group">
                    <label for="bandMembers">Number of Band Members</label>
                    <input type="number" id="bandMembers" value="4">
                    <div class="helper-text">Number of musicians excluding yourself</div>
                </div>

                <div class="form-group">
                    <label for="yourNetPercent">Your % of Net</label>
                    <input type="number" id="yourNetPercent" value="38">
                    <div class="helper-text">Standard is 25% for ethical bandleader compensation</div>
                </div>

                <div class="form-group">
                    <label for="includeBuffer">Include Buffer?</label>
                    <select id="includeBuffer">
                        <option value="Y">Yes</option>
                        <option value="N">No</option>
                    </select>
                    <div class="helper-text">Set to Yes to include a contingency buffer</div>
                </div>

                <div class="form-group">
                    <label for="bufferPercent">Buffer %</label>
                    <input type="number" id="bufferPercent" value="12">
                    <div class="helper-text">Percentage of net to hold as contingency</div>
                </div>

                <div class="form-group">
                    <label for="perDiem">Per diem per Musician</label>
                    <div class="currency-input">
                        <span class="currency-symbol" id="currencySymbol3">€</span>
                        <input type="number" id="perDiem" value="30">
                    </div>
                    <div class="helper-text">Daily allowance for each musician</div>
                </div>
                
                <div class="mt-4 pt-4 border-t">
                    <h3 class="font-medium mb-2">Currency Conversion Rates</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="eurToGbp" class="text-sm">€ to £ Rate</label>
                            <input type="number" step="0.0001" id="eurToGbp" value="0.8683" class="mt-1">
                        </div>
                        <div>
                            <label for="eurToUsd" class="text-sm">€ to $ Rate</label>
                            <input type="number" step="0.0001" id="eurToUsd" value="1.0764" class="mt-1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="section">
                <h2 class="section-title blue-bg">Calculated Values</h2>
                
                <div class="form-group">
                    <label>Booking Fee</label>
                    <div class="result-box" id="bookingFee">€0.00</div>
                </div>

                <div class="form-group">
                    <label>Net Available</label>
                    <div class="result-box" id="netAvailable">€0.00</div>
                </div>

                <div class="form-group">
                    <label>Buffer Amount</label>
                    <div class="result-box" id="bufferAmount">€0.00</div>
                </div>

                <div class="form-group">
                    <label>Working Net</label>
                    <div class="result-box" id="workingNet">€0.00</div>
                </div>

                <h2 class="section-title green-bg mt-6">Results</h2>
                
                <div class="form-group">
                    <label>Your Compensation</label>
                    <div class="result-box font-bold" id="yourCompensation">€0.00</div>
                    <div class="grid grid-cols-3 gap-1 mt-1 text-xs text-gray-500">
                        <div>€: <span id="yourCompEUR">€0.00</span></div>
                        <div>£: <span id="yourCompGBP">£0.00</span></div>
                        <div>$: <span id="yourCompUSD">$0.00</span></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Per Musician with Per Diem</label>
                    <div class="result-box font-bold" id="perMusicianWithPerDiem">€0.00</div>
                    <div class="grid grid-cols-3 gap-1 mt-1 text-xs text-gray-500">
                        <div>€: <span id="musicianEUR">€0.00</span></div>
                        <div>£: <span id="musicianGBP">£0.00</span></div>
                        <div>$: <span id="musicianUSD">$0.00</span></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Leader-to-Musician Ratio</label>
                    <div class="result-box" id="leaderRatio">0.00</div>
                </div>

                <div class="form-group">
                    <label>Ethical Assessment</label>
                    <div class="result-box" id="fairnessRating">-</div>
                </div>
                
                <h2 class="section-title purple-bg mt-6">Alternative Scenarios</h2>
                
                <div class="overflow-x-auto">
                    <table>
                        <thead>
                            <tr>
                                <th>Scenario</th>
                                <th>Your Fee</th>
                                <th>Per Musician</th>
                                <th>With Per Diem</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>With 20% for you</td>
                                <td id="twentyPercentYourFee">€0.00</td>
                                <td id="twentyPercentPerMusician">€0.00</td>
                                <td id="twentyPercentWithPerDiem">€0.00</td>
                            </tr>
                            <tr>
                                <td>With 30% for you</td>
                                <td id="thirtyPercentYourFee">€0.00</td>
                                <td id="thirtyPercentPerMusician">€0.00</td>
                                <td id="thirtyPercentWithPerDiem">€0.00</td>
                            </tr>
                            <tr class="bg-gray-50">
                                <td id="currentScenario">Current (38% for you)</td>
                                <td id="currentYourFee" class="font-medium text-indigo-600">€0.00</td>
                                <td id="currentPerMusician">€0.00</td>
                                <td id="currentWithPerDiem">€0.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="reference-box">
                    <h3 class="text-lg font-medium mb-2">Reference Guide</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-medium">Typical Ranges</h4>
                            <ul class="mt-2 text-sm space-y-1">
                                <li>• Conservative approach: 20% for bandleader, 80% split among musicians</li>
                                <li>• Standard approach: 25% for bandleader, 75% split among musicians</li>
                                <li>• Aggressive approach: 30% for bandleader, 70% split among musicians</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-medium">Tips for Fair Compensation</h4>
                            <ul class="mt-2 text-sm space-y-1">
                                <li>• Buffer amount typically covers unexpected expenses</li>
                                <li>• Per diems should be consistent for all band members</li>
                                <li>• Leader-to-Musician ratio between 1.5-2.5 is considered fair</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-backdrop" style="display: none;">
        <div class="modal">
            <h3 class="text-lg font-medium mb-4">Confirm Delete</h3>
            <p>Are you sure you want to delete this saved calculation?</p>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancelDelete" class="btn px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300" onclick="document.getElementById('confirmModal').style.display = 'none';">Cancel</button>
                <button id="confirmDelete" class="btn btn-red" onclick="deleteCalculation(this.getAttribute('data-id'))">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Set default date to today
        document.getElementById('gigDate').valueAsDate = new Date();
        
        // Format currency - Euro format
        function formatCurrency(amount, currency = 'EUR') {
            const currencyMap = {
                'EUR': { locale: 'de-DE', currency: 'EUR', symbol: '€' },
                'GBP': { locale: 'en-GB', currency: 'GBP', symbol: '£' },
                'USD': { locale: 'en-US', currency: 'USD', symbol: '$' }
            };
            
            const formatInfo = currencyMap[currency] || currencyMap['EUR'];
            
            return new Intl.NumberFormat(formatInfo.locale, { 
                style: 'currency', 
                currency: formatInfo.currency
            }).format(amount);
        }
        
        // Convert currency values
        function convertCurrency(amount, fromCurrency, toCurrency) {
            if (fromCurrency === toCurrency) return amount;
            
            const eurToGbp = parseFloat(document.getElementById('eurToGbp').value) || 0.8683;
            const eurToUsd = parseFloat(document.getElementById('eurToUsd').value) || 1.0764;
            
            if (fromCurrency === 'EUR') {
                if (toCurrency === 'GBP') return amount * eurToGbp;
                if (toCurrency === 'USD') return amount * eurToUsd;
            }
            if (fromCurrency === 'GBP') {
                if (toCurrency === 'EUR') return amount / eurToGbp;
                if (toCurrency === 'USD') return (amount / eurToGbp) * eurToUsd;
            }
            if (fromCurrency === 'USD') {
                if (toCurrency === 'EUR') return amount / eurToUsd;
                if (toCurrency === 'GBP') return (amount / eurToUsd) * eurToGbp;
            }
            
            return amount;
        }
        
        // Calculate all results
        function calculateResults() {
            // Get all input values
            const grossFee = parseFloat(document.getElementById('grossFee').value) || 0;
            const bookingFeePercent = parseFloat(document.getElementById('bookingFeePercent').value) || 0;
            const transportCosts = parseFloat(document.getElementById('transportCosts').value) || 0;
            const bandMembers = parseInt(document.getElementById('bandMembers').value) || 0;
            const yourNetPercent = parseFloat(document.getElementById('yourNetPercent').value) || 0;
            const includeBuffer = document.getElementById('includeBuffer').value === 'Y';
            const bufferPercent = parseFloat(document.getElementById('bufferPercent').value) || 0;
            const perDiem = parseFloat(document.getElementById('perDiem').value) || 0;
            const currency = document.getElementById('currency').value;
            
            // Update currency symbols
            const currencySymbol = currency === 'EUR' ? '€' : currency === 'GBP' ? '£' : '$';
            document.getElementById('currencySymbol').textContent = currencySymbol;
            document.getElementById('currencySymbol2').textContent = currencySymbol;
            document.getElementById('currencySymbol3').textContent = currencySymbol;
            
            // Core calculations
            const bookingFee = grossFee * (bookingFeePercent / 100);
            const netAvailable = grossFee - bookingFee - transportCosts;
            const bufferAmount = includeBuffer ? netAvailable * (bufferPercent / 100) : 0;
            const workingNet = netAvailable - bufferAmount;
            
            const yourCompensation = workingNet * (yourNetPercent / 100);
            const totalBandCompensation = workingNet * (1 - (yourNetPercent / 100));
            const perMusician = bandMembers > 0 ? totalBandCompensation / bandMembers : 0;
            const perMusicianWithPerDiem = perMusician + perDiem;
            const leaderRatio = perMusician > 0 ? yourCompensation / perMusician : 0;
            
            // Alternative scenarios
            const twentyPercentYourFee = workingNet * 0.2;
            const twentyPercentPerMusician = bandMembers > 0 ? workingNet * 0.8 / bandMembers : 0;
            const twentyPercentWithPerDiem = twentyPercentPerMusician + perDiem;
            
            const thirtyPercentYourFee = workingNet * 0.3;
            const thirtyPercentPerMusician = bandMembers > 0 ? workingNet * 0.7 / bandMembers : 0;
            const thirtyPercentWithPerDiem = thirtyPercentPerMusician + perDiem;
            
            // Fairness rating
            let fairnessRating = '';
            const fairnessElement = document.getElementById('fairnessRating');
            
            if (leaderRatio < 1.5) {
                fairnessRating = 'Below typical range';
                fairnessElement.className = 'result-box ethical-warning';
            } else if (leaderRatio > 2.5) {
                fairnessRating = 'Above typical range';
                fairnessElement.className = 'result-box ethical-bad';
            } else {
                fairnessRating = 'Within ethical range';
                fairnessElement.className = 'result-box ethical-good';
            }
            
            // Update calculated values
            document.getElementById('bookingFee').textContent = formatCurrency(bookingFee, currency);
            document.getElementById('netAvailable').textContent = formatCurrency(netAvailable, currency);
            document.getElementById('bufferAmount').textContent = formatCurrency(bufferAmount, currency);
            document.getElementById('workingNet').textContent = formatCurrency(workingNet, currency);
            
            // Update results
            document.getElementById('yourCompensation').textContent = formatCurrency(yourCompensation, currency);
            document.getElementById('perMusicianWithPerDiem').textContent = formatCurrency(perMusicianWithPerDiem, currency);
            document.getElementById('leaderRatio').textContent = leaderRatio.toFixed(2);
            document.getElementById('fairnessRating').textContent = fairnessRating;
            
            // Update currency conversions
            document.getElementById('yourCompEUR').textContent = formatCurrency(convertCurrency(yourCompensation, currency, 'EUR'), 'EUR');
            document.getElementById('yourCompGBP').textContent = formatCurrency(convertCurrency(yourCompensation, currency, 'GBP'), 'GBP');
            document.getElementById('yourCompUSD').textContent = formatCurrency(convertCurrency(yourCompensation, currency, 'USD'), 'USD');
            
            document.getElementById('musicianEUR').textContent = formatCurrency(convertCurrency(perMusicianWithPerDiem, currency, 'EUR'), 'EUR');
            document.getElementById('musicianGBP').textContent = formatCurrency(convertCurrency(perMusicianWithPerDiem, currency, 'GBP'), 'GBP');
            document.getElementById('musicianUSD').textContent = formatCurrency(convertCurrency(perMusicianWithPerDiem, currency, 'USD'), 'USD');
            
            // Update alternative scenarios
            document.getElementById('twentyPercentYourFee').textContent = formatCurrency(twentyPercentYourFee, currency);
            document.getElementById('twentyPercentPerMusician').textContent = formatCurrency(twentyPercentPerMusician, currency);
            document.getElementById('twentyPercentWithPerDiem').textContent = formatCurrency(twentyPercentWithPerDiem, currency);
            
            document.getElementById('thirtyPercentYourFee').textContent = formatCurrency(thirtyPercentYourFee, currency);
            document.getElementById('thirtyPercentPerMusician').textContent = formatCurrency(thirtyPercentPerMusician, currency);
            document.getElementById('thirtyPercentWithPerDiem').textContent = formatCurrency(thirtyPercentWithPerDiem, currency);
            
            document.getElementById('currentScenario').textContent = `Current (${yourNetPercent}% for you)`;
            document.getElementById('currentYourFee').textContent = formatCurrency(yourCompensation, currency);
            document.getElementById('currentPerMusician').textContent = formatCurrency(perMusician, currency);
            document.getElementById('currentWithPerDiem').textContent = formatCurrency(perMusicianWithPerDiem, currency);
        }
        
        // Save current calculation
        function saveCalculation() {
            const saveName = document.getElementById('saveName').value.trim();
            if (!saveName) {
                alert('Please enter a name for this calculation');
                return;
            }
            
            try {
                // Get all input values
                const venueName = document.getElementById('venueName').value;
                const venueLocation = document.getElementById('venueLocation').value;
                const gigDate = document.getElementById('gigDate').value;
                const grossFee = document.getElementById('grossFee').value;
                const bookingFeePercent = document.getElementById('bookingFeePercent').value;
                const transportCosts = document.getElementById('transportCosts').value;
                const bandMembers = document.getElementById('bandMembers').value;
                const yourNetPercent = document.getElementById('yourNetPercent').value;
                const includeBuffer = document.getElementById('includeBuffer').value;
                const bufferPercent = document.getElementById('bufferPercent').value;
                const perDiem = document.getElementById('perDiem').value;
                const currency = document.getElementById('currency').value;
                const eurToGbp = document.getElementById('eurToGbp').value;
                const eurToUsd = document.getElementById('eurToUsd').value;
                
                // Create calculation object
                const calculation = {
                    id: Date.now().toString(), // Unique ID based on timestamp
                    name: saveName,
                    date: new Date().toISOString(),
                    gigInfo: {
                        venueName,
                        venueLocation,
                        gigDate
                    },
                    inputValues: {
                        grossFee,
                        bookingFeePercent,
                        transportCosts,
                        bandMembers,
                        yourNetPercent,
                        includeBuffer,
                        bufferPercent,
                        perDiem,
                        currency,
                        eurToGbp,
                        eurToUsd
                    }
                };
                
                // Get existing saved calculations or initialize empty array
                let savedCalculations = [];
                try {
                    const existing = localStorage.getItem('bandleaderCalculations');
                    if (existing) {
                        savedCalculations = JSON.parse(existing);
                    }
                } catch (e) {
                    console.error("Error reading from localStorage", e);
                    savedCalculations = [];
                }
                
                // Add new calculation
                savedCalculations.push(calculation);
                
                // Save to localStorage
                localStorage.setItem('bandleaderCalculations', JSON.stringify(savedCalculations));
                
                // Clear save name field
                document.getElementById('saveName').value = '';
                
                // Refresh saved calculations list
                loadSavedCalculations();
                
                alert('Calculation saved successfully!');
            } catch (e) {
                console.error("Error saving calculation", e);
                alert('Error saving calculation: ' + e.message);
            }
        }
        
        // Load all saved calculations
        function loadSavedCalculations() {
            let savedCalculations = [];
            try {
                const data = localStorage.getItem('bandleaderCalculations');
                if (data) {
                    savedCalculations = JSON.parse(data);
                }
            } catch (e) {
                console.error("Error loading saved calculations", e);
                savedCalculations = [];
            }
            
            const container = document.getElementById('savedCalculations');
            
            // Clear container
            container.innerHTML = '';
            
            if (!savedCalculations || savedCalculations.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-sm italic">No saved calculations yet</div>';
                return;
            }
            
            // Sort by date, most recent first
            savedCalculations.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Add each saved calculation
            savedCalculations.forEach(calc => {
                const formattedDate = new Date(calc.date).toLocaleDateString();
                const venueInfo = calc.gigInfo && calc.gigInfo.venueName ? 
                    `${calc.gigInfo.venueName}${calc.gigInfo.venueLocation ? ', ' + calc.gigInfo.venueLocation : ''}` : 
                    'No venue specified';
                
                const item = document.createElement('div');
                item.className = 'saved-item';
                item.innerHTML = `
                    <div class="saved-item-details">
                        <div class="font-medium">${calc.name}</div>
                        <div class="text-sm text-gray-600">${venueInfo}</div>
                        <div class="text-xs text-gray-500">Saved: ${formattedDate}</div>
                    </div>
                    <div class="saved-item-buttons">
                        <button class="btn btn-green" onclick="loadCalculation('${calc.id}')">Load</button>
                        <button class="btn btn-red" onclick="showDeleteConfirmation('${calc.id}')">Delete</button>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        // Load a specific calculation
        function loadCalculation(id) {
            try {
                const savedCalculations = JSON.parse(localStorage.getItem('bandleaderCalculations')) || [];
                const calculation = savedCalculations.find(calc => calc.id === id);
                
                if (!calculation) {
                    alert('Calculation not found');
                    return;
                }
                
                // Set venue info
                document.getElementById('venueName').value = calculation.gigInfo.venueName || '';
                document.getElementById('venueLocation').value = calculation.gigInfo.venueLocation || '';
                document.getElementById('gigDate').value = calculation.gigInfo.gigDate || '';
                
                // Set input values
                document.getElementById('grossFee').value = calculation.inputValues.grossFee || '';
                document.getElementById('bookingFeePercent').value = calculation.inputValues.bookingFeePercent || '';
                document.getElementById('transportCosts').value = calculation.inputValues.transportCosts || '';
                document.getElementById('bandMembers').value = calculation.inputValues.bandMembers || '';
                document.getElementById('yourNetPercent').value = calculation.inputValues.yourNetPercent || '';
                document.getElementById('includeBuffer').value = calculation.inputValues.includeBuffer || 'Y';
                document.getElementById('bufferPercent').value = calculation.inputValues.bufferPercent || '';
                document.getElementById('perDiem').value = calculation.inputValues.perDiem || '';
                document.getElementById('currency').value = calculation.inputValues.currency || 'EUR';
                document.getElementById('eurToGbp').value = calculation.inputValues.eurToGbp || '0.8683';
                document.getElementById('eurToUsd').value = calculation.inputValues.eurToUsd || '1.0764';
                
                // Recalculate
                calculateResults();
                
                alert('Calculation loaded successfully!');
            } catch (e) {
                console.error("Error loading calculation", e);
                alert('Error loading calculation: ' + e.message);
            }
        }
        
        // Show delete confirmation modal
        function showDeleteConfirmation(id) {
            document.getElementById('confirmModal').style.display = 'flex';
            document.getElementById('confirmDelete').setAttribute('data-id', id);
        }
        
        // Delete a saved calculation
        function deleteCalculation(id) {
            try {
                let savedCalculations = JSON.parse(localStorage.getItem('bandleaderCalculations')) || [];
                savedCalculations = savedCalculations.filter(calc => calc.id !== id);
                localStorage.setItem('bandleaderCalculations', JSON.stringify(savedCalculations));
                
                // Hide modal
                document.getElementById('confirmModal').style.display = 'none';
                
                // Refresh list
                loadSavedCalculations();
                
                alert('Calculation deleted successfully!');
            } catch (e) {
                console.error("Error deleting calculation", e);
                alert('Error deleting calculation: ' + e.message);
            }
        }
        
        // Export all calculations to a JSON file
        function exportCalculations() {
            try {
                const savedCalculations = localStorage.getItem('bandleaderCalculations') || '[]';
                
                // Create a Blob with the JSON data
                const blob = new Blob([savedCalculations], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Create a download link and trigger it
                const a = document.createElement('a');
                a.href = url;
                a.download = `bandleader-calculations-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 0);
                
                alert('Calculations exported successfully!');
            } catch (e) {
                console.error("Error exporting calculations", e);
                alert('Error exporting calculations: ' + e.message);
            }
        }
        
        // Set up auto-calculation events for all inputs
        function setupAutoCalculate() {
            // Get all input and select elements
            const inputs = document.querySelectorAll('input[type="number"], input[type="text"], select');
            
            // Add event listeners for various input events
            inputs.forEach(input => {
                ['input', 'change', 'keyup'].forEach(eventType => {
                    input.addEventListener(eventType, calculateResults);
                });
            });
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedCalculations();
            calculateResults(); // Initial calculation
            setupAutoCalculate(); // Set up auto-calculation
            
            // Add currency change event listener
            document.getElementById('currency').addEventListener('change', calculateResults);
            
            // Set up import file handler
            document.getElementById('importFile').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = e.target.result;
                        const parsedData = JSON.parse(importedData);
                        
                        // Validate that it's an array
                        if (!Array.isArray(parsedData)) {
                            throw new Error('Invalid data format');
                        }
                        
                        // Merge with existing data or replace completely
                        if (confirm('Do you want to merge with existing calculations? Click OK to merge, Cancel to replace all.')) {
                            // Merge - get existing calculations
                            const existingData = JSON.parse(localStorage.getItem('bandleaderCalculations') || '[]');
                            
                            // Create a map of IDs to identify duplicates
                            const existingIds = new Map(existingData.map(item => [item.id, true]));
                            
                            // Add only non-duplicate items
                            const newData = [...existingData];
                            parsedData.forEach(item => {
                                if (!existingIds.has(item.id)) {
                                    newData.push(item);
                                }
                            });
                            
                            localStorage.setItem('bandleaderCalculations', JSON.stringify(newData));
                        } else {
                            // Replace all
                            localStorage.setItem('bandleaderCalculations', JSON.stringify(parsedData));
                        }
                        
                        // Refresh the display
                        loadSavedCalculations();
                        alert('Calculations imported successfully!');
                        
                    } catch (e) {
                        console.error("Error importing calculations", e);
                        alert('Error importing calculations: ' + e.message);
                    }
                    
                    // Reset the file input
                    event.target.value = '';
                };
                
                reader.readAsText(file);
            });
        });
    </script>
</body>
</html>
